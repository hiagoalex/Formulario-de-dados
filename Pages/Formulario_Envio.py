import streamlit as st
import pandas as pd
from datetime import date, timedelta


st.set_page_config(
    page_title="Formul√°rio de Solicita√ß√£o de Relat√≥rio",
    layout="centered"
)


if 'solicitacao_data' not in st.session_state:
    st.session_state.solicitacao_data = {}
if 'formulario_enviado' not in st.session_state:
    st.session_state.formulario_enviado = False



st.title("üìÑ Formul√°rio de Solicita√ß√£o de Relat√≥rio")
st.markdown("---")

st.markdown(
    """
    Ol√°! Neste formul√°rio voc√™ responder√° algumas perguntas sobre o que deseja investigar: 
    o objetivo da an√°lise, quais indicadores e m√©tricas voc√™ considera essenciais e indispens√°veis, 
    qual(ais) setor(es) envolvido(s), o prazo em que voc√™ espera receber esse reporte e o mais essencial: a fonte de dados.
    
    Cada informa√ß√£o √© importante, ent√£o n√£o deixe nada de fora!
    """
)

if st.session_state.formulario_enviado:
    st.success("‚úÖ **Solicita√ß√£o Enviada com Sucesso!**")
    st.info("O Analista de Dados foi notificado e pode acessar o Painel Restrito (Home).")
    
    if st.button("Enviar Nova Solicita√ß√£o"):
        st.session_state.formulario_enviado = False
        st.rerun()

else:
    
    with st.form("solicitacao_relatorio_form", clear_on_submit=True):
        
        st.header("Detalhes da An√°lise")

        
        objetivo_analise = st.text_area(
            "1. Qual o **Objetivo da An√°lise**? (O que deseja investigar?) *",
            height=100,
            placeholder="Ex: Identificar a causa da queda de vendas na regi√£o Sudeste no √∫ltimo trimestre."
        )

        
        indicadores = st.text_area(
            "2. Quais **Indicadores e M√©tricas** voc√™ considera essenciais e indispens√°veis? *",
            height=70,
            placeholder="Ex: Volume de Vendas, Margem de Lucro, Taxa de Convers√£o, Ticket M√©dio."
        )
        
        
        st.markdown("**Quais as pessoas e/ou setores envolvidos?***")
        setores_envolvidos = st.text_area(
            "Incluir quem precisa ter acesso ao link do relat√≥rio, quem pode esclarecer d√∫vidas sobre a base ou projeto...",
            height=70,
            placeholder="Ex: Jo√£o, Maria, Diretoria de Vendas..."
        )

        st.markdown("---")
        st.header("Prazo e Fonte de Dados")
        
        
        st.markdown("**Prazo esperado de entrega do relat√≥rio***")
        st.caption("Tenha em mente um prazo realista e com o m√≠nimo de 2 dias.")
        prazo_esperado = st.date_input(
            "Selecione a data de vencimento",
            min_value=date.today() + timedelta(days=2),
            value=date.today() + timedelta(days=5) 
        )

        
        st.subheader("Fonte de Dados *")
        st.caption("Voc√™ pode anexar o arquivo OU fornecer um link.")

        col_file, col_link = st.columns(2)

        with col_file:
            arquivo_upload = st.file_uploader(
                "Precisa anexar arquivos? Solte seu arquivo (Excel/CSV) aqui.",
                type=['xlsx', 'csv'],
                accept_multiple_files=False
            )
        
        with col_link:
            link_planilha = st.text_input(
                "OU cole o link da planilha/base (Google Sheets, OneDrive, etc.)",
                placeholder="https://docs.google.com/spreadsheets/d/..."
            )


        st.markdown("---")
        
        
        submitted = st.form_submit_button("Enviar Solicita√ß√£o", type="primary")

        if submitted:
            
            if not objetivo_analise:
                st.error("‚ö†Ô∏è **Erro:** O campo 'Objetivo da An√°lise' √© obrigat√≥rio.")
            elif not indicadores:
                st.error("‚ö†Ô∏è **Erro:** O campo 'Indicadores e M√©tricas' √© obrigat√≥rio.")
            elif not setores_envolvidos:
                st.error("‚ö†Ô∏è **Erro:** O campo 'Pessoas e/ou setores envolvidos' √© obrigat√≥rio.")
            elif not arquivo_upload and not link_planilha:
                st.error("‚ö†Ô∏è **Erro:** A Fonte de Dados (arquivo OU link) √© obrigat√≥ria.")
            else:
                
                st.session_state.solicitacao_data = {
                    'objetivo': objetivo_analise,
                    'indicadores': indicadores,
                    'setores': setores_envolvidos,
                    'prazo': prazo_esperado.strftime("%d/%m/%Y"),
                    'file': arquivo_upload,
                    'link': link_planilha,
                    'timestamp': pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                st.session_state.formulario_enviado = True
                st.rerun()